#include "main.h"
#include "uart.h"
#include "adc.h"

// 全局变量定义
#pragma data:data  // 将变量放在数据段
volatile unsigned int ADC_Values[4] = {0};
volatile unsigned char ADC_Ready = 0;
DataPacket packet = {0x55, 0, 0, 0, 0, 0xFF};
#pragma data:data

// 简单的延时函数
void Delay_ms(unsigned int ms) {
    unsigned int i, j;
    for(i = 0; i < ms; i++) {
        for(j = 0; j < 1140; j++) {  // 16MHz时钟下的粗略延时
            asm("nop");
        }
    }
}

int main(void) {
    // 系统初始化
    System_Init();
    
    // 启动ADC连续采样
    ADC_StartContinuousConversion();
    
    while(1) {
        // 处理ADC数据
        Process_ADC_Data();
        
        // 发送数据包
        Send_Data_Packet();
        
        // 延时，控制发送速率（约10Hz）
        Delay_ms(100);
    }
}

void System_Init(void) {
    // 初始化串口
    UART_Init();
    
    // 初始化ADC
    ADC_Init();
    
    // 全局中断使能
    asm("sei");
}

void Process_ADC_Data(void) {
    if(ADC_Ready) {
        // 将ADC值转换为电压值（0-5V对应0-255）
        // 假设参考电压为5V，ADC为10位
        packet.adc0 = (unsigned char)(ADC_Values[0] >> 2);  // 取高8位
        packet.adc1 = (unsigned char)(ADC_Values[1] >> 2);  // 取高8位
        packet.adc2 = (unsigned char)(ADC_Values[2] >> 2);  // 取高8位
        packet.adc3 = (unsigned char)(ADC_Values[3] >> 2);  // 取高8位
        
        ADC_Ready = 0;
    }
}

void Send_Data_Packet(void) {
    // 发送帧头
    UART_Transmit(packet.header);
    
    // 发送ADC数据
    UART_Transmit(packet.adc0);
    UART_Transmit(packet.adc1);
    UART_Transmit(packet.adc2);
    UART_Transmit(packet.adc3);
    
    // 发送帧尾
    UART_Transmit(packet.footer);
	UART_Transmit(packet.footer);
	UART_Transmit(packet.footer);
}